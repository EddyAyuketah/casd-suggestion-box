#!/usr/bin/env python3
"""
Export shipment data to NAZ for dashboard consumption
Run this every 15 minutes via Task Scheduler
"""
import json
from datetime import datetime, timedelta
import sys
from pathlib import Path

def export_shipments():
    """
    Query PyUber and export shipment data to JSON on NAZ
    """
    try:
        import PyUber
        import pandas as pd
        
        # Configuration
        BE_LSB_OPERATION = 9812
        QUARTER_START = datetime(2025, 9, 6, 18, 0)
        
        # Connect to database
        db = PyUber.connect("F32_PROD_XEUS")
        now = datetime.now()
        
        print(f"üîÑ Querying shipment data at {now:%Y-%m-%d %H:%M:%S}...")
        
        # =====================================================
        # QUERY: QUARTERLY SHIPMENTS
        # =====================================================
        quarter_sql = f"""
        SELECT SUM(WAFER_QTY) AS TOTAL_WAFERS
        FROM F_LOT_RUN_CARD
        WHERE
            OUT_DATE >= TO_DATE('{QUARTER_START:%m/%d/%Y %H:%M}', 'MM/DD/YYYY HH24:MI')
            AND OUT_DATE <= SYSDATE
            AND LOT_TYPE IN ('PROD','ENG')
            AND (LOT LIKE 'L%' OR LOT LIKE 'N%')
            AND LOT NOT LIKE 'L9%'
            AND OPERATION = {BE_LSB_OPERATION}
            AND WAFER_QTY > 0
        """
        
        quarter_df = pd.read_sql(quarter_sql, db)
        quarter_ships = int(quarter_df["TOTAL_WAFERS"].iloc[0] or 0)
        
        # =====================================================
        # BUILD OUTPUT
        # =====================================================
        output = {
            "quarter_ships": quarter_ships,
            "timestamp": now.isoformat(),
            "last_updated": now.strftime("%Y-%m-%d %H:%M:%S"),
            "quarter_start": QUARTER_START.isoformat(),
            "operation": BE_LSB_OPERATION
        }
        
        # =====================================================
        # EXPORT TO NAZ
        # =====================================================
        output_path = r"\\azshfs.intel.com\azanalysistop\AZAnalysis\1274_MAODATA\MfgEng\COS_DB\shipments.json"
        
        with open(output_path, 'w') as f:
            json.dump(output, f, indent=2)
        
        print(f"‚úÖ Shipment data exported successfully!")
        print(f"   Quarter Ships: {quarter_ships:,}")
        print(f"   Output: {output_path}")
        
        return output
        
    except Exception as e:
        error_msg = f"‚ùå Export failed: {str(e)}"
        print(error_msg)
        
        # Write error to log file
        log_path = r"\\azshfs.intel.com\azanalysistop\AZAnalysis\1274_MAODATA\MfgEng\COS_DB\shipments_error.log"
        try:
            with open(log_path, 'a') as f:
                f.write(f"{datetime.now().isoformat()} - {error_msg}\n")
        except:
            pass
        
        sys.exit(1)


if __name__ == "__main__":
    export_shipments()
